<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StartCopy Inventario</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .portable-badge {
            position: absolute;
            top: 10px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff4500, #ff6500);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
        }

        .logo::before {
            content: "‚≠ê";
            font-size: 24px;
            color: #ffd700;
        }

        .controls {
            padding: 20px;
            background-color: #ecf0f1;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls input, .controls select, .controls button {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .controls button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .controls button:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60 !important;
        }

        .btn-success:hover {
            background-color: #229954 !important;
        }

        .btn-danger {
            background-color: #e74c3c !important;
        }

        .btn-danger:hover {
            background-color: #c0392b !important;
        }

        .btn-warning {
            background-color: #f39c12 !important;
        }

        .btn-warning:hover {
            background-color: #e67e22 !important;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background-color: #34495e;
            color: #000000; /* Cambiado a negro */
            font-weight: bold;
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 8px;
            border: 1px solid #bdc3c7;
            text-align: center;
            background-color: white;
        }

        .section-header {
            background-color: #95a5a6;
            color: white;
            font-weight: bold;
        }

        .inventory-section {
            background-color: #a8cdf0;
        }

        .sales-section {
            background-color: #f8b7b7;
        }

        .entries-section {
            background-color: #b7f8b7;
        }

        .profit-section {
            background-color: #fff2b7;
        }

        tr:nth-child(even) td {
            background-color: #f8f9fa;
        }

        tr:hover td {
            background-color: #e8f4f8;
        }

        .editable {
            background-color: transparent;
            border: none;
            width: 100%;
            text-align: center;
            font-size: 12px;
        }

        .editable:focus {
            background-color: #fff;
            border: 1px solid #3498db;
            outline: none;
        }

        .profit-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .profit-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }

        .summary {
            padding: 20px;
            background-color: #ecf0f1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .status-bar {
            background-color: #34495e;
            color: white;
            padding: 10px 20px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auto-save-indicator {
            color: #27ae60;
            font-weight: bold;
        }

        .file-input {
            display: none;
        }

        .offline-indicator {
            background-color: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .online-indicator {
            background-color: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        /* Estilos para el login */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 400px;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff4500, #ff6500);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 36px;
        }

        .login-form h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .login-form input, .login-form select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff4500, #ff6500);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .login-form button:hover {
            opacity: 0.9;
        }

        .auth-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
        }

        .user-info {
            background-color: #27ae60;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .logout-btn {
            background-color: #e74c3c !important;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .logout-btn:hover {
            background-color: #c0392b !important;
        }
    </style>
</head>
<body>
    <!-- Sistema de Login -->
    <div id="loginContainer" class="login-container">
        <div class="login-form">
            <div class="login-logo">‚≠ê</div>
            <h2>StartCopy Inventario</h2>
            <div id="loginSection">
                <h3>Iniciar Sesi√≥n</h3>
                <select id="userRole">
                    <option value="">Seleccionar rol...</option>
                    <option value="jefe">Jefe</option>
                    <option value="administrador">Administrador</option>
                </select>
                <input type="password" id="userPassword" placeholder="Contrase√±a">
                <button onclick="login()">üîê Iniciar Sesi√≥n</button>
                <button onclick="showCreatePassword()" style="background: #3498db;">üë§ Crear/Cambiar Contrase√±a</button>
            </div>
            
            <div id="createPasswordSection" style="display: none;">
                <h3>Crear/Cambiar Contrase√±a</h3>
                <select id="newUserRole">
                    <option value="">Seleccionar rol...</option>
                    <option value="jefe">Jefe</option>
                    <option value="administrador">Administrador</option>
                </select>
                <input type="password" id="newPassword" placeholder="Nueva contrase√±a">
                <input type="password" id="confirmPassword" placeholder="Confirmar contrase√±a">
                <button onclick="createPassword()">üíæ Guardar Contrase√±a</button>
                <button onclick="showLogin()" style="background: #95a5a6;">‚¨ÖÔ∏è Volver</button>
            </div>

            <div class="auth-info">
                <strong>Sistema de Seguridad Activado</strong><br>
                ‚Ä¢ Jefe: Control total del inventario<br>
                ‚Ä¢ Administrador: Gesti√≥n completa<br>
                ‚Ä¢ Las contrase√±as se guardan de forma segura
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="portable-badge">üì± PORTABLE</div>
            <div class="logo"></div>
            <h1>STARTCOPY INVENTARIO</h1>
            <p>Sistema de Gesti√≥n con Control de Ganancias</p>
        </div>

        <div class="controls">
            <span class="user-info" id="currentUser">üë§ Usuario: Invitado</span>
            <button class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
            <button onclick="openModal('product')" class="btn-success">‚ûï Agregar Producto</button>
            <button onclick="openModal('sale')" class="btn-danger">üõí Registrar Venta</button>
            <button onclick="openModal('entry')">üì¶ Registrar Entrada</button>
            <button onclick="openModal('invoice')" class="btn-warning">üßæ Generar Factura</button>
            <button onclick="exportCompleteData()" class="btn-success">üíæ Exportar Datos</button>
            <button onclick="document.getElementById('importFile').click()" class="btn-warning">üì§ Importar Datos</button>
            <button onclick="clearAllData()" class="btn-danger">üóëÔ∏è Limpiar Todo</button>
            <input type="text" id="searchInput" placeholder="üîç Buscar producto..." onkeyup="filterProducts()">
            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(this)">
        </div>

        <div class="table-container">
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th rowspan="2" class="inventory-section">C√ìDIGO<br>PRODUCTO</th>
                        <th rowspan="2" class="inventory-section">DESCRIPCI√ìN</th>
                        <th rowspan="2" class="inventory-section">EXISTENCIAS<br>INICIALES</th>
                        <th rowspan="2" class="inventory-section">ENTRADAS</th>
                        <th rowspan="2" class="inventory-section">SALIDAS</th>
                        <th rowspan="2" class="inventory-section">STOCK<br>ACTUAL</th>
                        <th rowspan="2" class="profit-section">PRECIO<br>BASE ($)</th>
                        <th rowspan="2" class="profit-section">PRECIO<br>VENTA ($)</th>
                        <th rowspan="2" class="profit-section">GANANCIA<br>UNITARIA ($)</th>
                        <th rowspan="2" class="profit-section">GANANCIA<br>TOTAL ($)</th>
                        <th colspan="3" class="sales-section">√öLTIMA VENTA</th>
                        <th colspan="3" class="entries-section">√öLTIMA ENTRADA</th>
                        <th rowspan="2" class="inventory-section">ACCIONES</th>
                    </tr>
                    <tr>
                        <th class="sales-section">CANTIDAD</th>
                        <th class="sales-section">FECHA</th>
                        <th class="sales-section">N¬∞ FACTURA</th>
                        <th class="entries-section">CANTIDAD</th>
                        <th class="entries-section">FECHA</th>
                        <th class="entries-section">N¬∞ FACTURA</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody">
                    <!-- Los datos se cargar√°n aqu√≠ din√°micamente -->
                </tbody>
            </table>
        </div>

        <div class="summary">
            <div class="summary-card">
                <h3>Total Productos</h3>
                <div class="value" id="totalProducts">0</div>
            </div>
            <div class="summary-card">
                <h3>Valor Total Inventario</h3>
                <div class="value" id="totalInventoryValue">$0</div>
            </div>
            <div class="summary-card">
                <h3>Ganancia Total</h3>
                <div class="value" id="totalProfit">$0</div>
            </div>
            <div class="summary-card">
                <h3>Productos Bajo Stock</h3>
                <div class="value" id="lowStock">0</div>
            </div>
        </div>

        <div class="status-bar">
            <div>
                <span class="auto-save-indicator" id="saveStatus">üíæ Auto-guardado activo</span>
                <span id="lastSaved"></span>
            </div>
            <div>
                <span id="connectionStatus" class="online-indicator">üåê StartCopy System</span>
                <span>Versi√≥n: 3.0</span>
            </div>
        </div>
    </div>

    <!-- Modal para generar facturas -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('invoice')">&times;</span>
            <h3>üßæ Generar Factura</h3>
            <form id="invoiceForm">
                <div class="form-group">
                    <label>Cliente:</label>
                    <input type="text" id="clientName" placeholder="Nombre del cliente" required>
                </div>
                <div class="form-group">
                    <label>N√∫mero de Factura:</label>
                    <input type="text" id="invoiceNumber" placeholder="Ej: F-001" required>
                </div>
                <div class="form-group">
                    <label>Productos vendidos (separados por coma):</label>
                    <select id="invoiceProducts" multiple>
                        <!-- Se llenar√° din√°micamente -->
                    </select>
                    <small>Mant√©n Ctrl presionado para seleccionar m√∫ltiples productos</small>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeModal('invoice')">Cancelar</button>
                    <button type="submit" class="btn-warning">üßæ Generar Factura</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Otros modales (mismo c√≥digo anterior) -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('product')">&times;</span>
            <h3>Agregar Producto</h3>
            <form id="productForm">
                <div class="form-group">
                    <label>C√≥digo del Producto:</label>
                    <input type="text" id="productCode" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <input type="text" id="productDescription" required>
                </div>
                <div class="form-group">
                    <label>Stock Inicial:</label>
                    <input type="number" id="initialStock" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Precio Base (Costo):</label>
                    <input type="number" id="basePrice" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Precio de Venta:</label>
                    <input type="number" id="salePrice" step="0.01" min="0" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeModal('product')">Cancelar</button>
                    <button type="submit" class="btn-success">Agregar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="saleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sale')">&times;</span>
            <h3>Registrar Venta</h3>
            <form id="saleForm">
                <div class="form-group">
                    <label>Producto:</label>
                    <select id="saleProduct" required>
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantidad:</label>
                    <input type="number" id="saleQuantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>N√∫mero de Factura:</label>
                    <input type="text" id="saleInvoice">
                </div>
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="saleDate" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeModal('sale')">Cancelar</button>
                    <button type="submit" class="btn-danger">Registrar Venta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="entryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('entry')">&times;</span>
            <h3>Registrar Entrada</h3>
            <form id="entryForm">
                <div class="form-group">
                    <label>Producto:</label>
                    <select id="entryProduct" required>
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantidad:</label>
                    <input type="number" id="entryQuantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>N√∫mero de Factura:</label>
                    <input type="text" id="entryInvoice">
                </div>
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="entryDate" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeModal('entry')">Cancelar</button>
                    <button type="submit" class="btn-success">Registrar Entrada</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let inventory = {};
        let currentUser = null;
        let userRole = null;
        const STORAGE_KEY = 'startcopy_inventario_v3';
        const AUTH_KEY = 'startcopy_auth';

        // Sistema de autenticaci√≥n mejorado
        function checkAuth() {
            console.log('üîç Verificando autenticaci√≥n...');
            const savedAuth = localStorage.getItem(AUTH_KEY);
            if (savedAuth) {
                try {
                    const authData = JSON.parse(savedAuth);
                    console.log('üìã Datos de auth encontrados:', Object.keys(authData));
                    return true; // Hay datos de autenticaci√≥n
                } catch (error) {
                    console.error('‚ùå Error al leer datos de auth:', error);
                    localStorage.removeItem(AUTH_KEY);
                }
            }
            console.log('‚ö†Ô∏è No hay datos de autenticaci√≥n');
            return false;
        }

        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('createPasswordSection').style.display = 'none';
            
            // Verificar si existen contrase√±as
            const authData = JSON.parse(localStorage.getItem(AUTH_KEY) || '{}');
            const hasPasswords = Object.keys(authData).length > 0;
            
            if (!hasPasswords) {
                document.getElementById('loginSection').innerHTML = `
                    <div style="background-color: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffc107;">
                        <h4 style="color: #856404; margin: 0 0 10px 0;">‚ö†Ô∏è Primera configuraci√≥n</h4>
                        <p style="color: #856404; margin: 0;">No existen contrase√±as configuradas. Debes crear las contrase√±as antes de poder acceder al sistema.</p>
                    </div>
                    <button onclick="showCreatePassword()" style="width: 100%; padding: 12px; background: #ffc107; color: #000; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        üîß Configurar Contrase√±as Primero
                    </button>
                `;
            } else {
                document.getElementById('loginSection').innerHTML = `
                    <h3>Iniciar Sesi√≥n</h3>
                    <select id="userRole">
                        <option value="">Seleccionar rol...</option>
                        <option value="jefe">Jefe</option>
                        <option value="administrador">Administrador</option>
                    </select>
                    <input type="password" id="userPassword" placeholder="Contrase√±a">
                    <button onclick="login()">üîê Iniciar Sesi√≥n</button>
                    <button onclick="showCreatePassword()" style="background: #3498db;">üë§ Crear/Cambiar Contrase√±a</button>
                `;
            }
        }

        function showCreatePassword() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('createPasswordSection').style.display = 'block';
        }

        function createPassword() {
            console.log('üîß Intentando crear contrase√±a...');
            const role = document.getElementById('newUserRole').value;
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            console.log('üìù Datos ingresados:', { role, password: password ? '***' : 'vac√≠o', confirmPassword: confirmPassword ? '***' : 'vac√≠o' });

            if (!role) {
                alert('‚ö†Ô∏è Debes seleccionar un rol');
                return false;
            }

            if (!password) {
                alert('‚ö†Ô∏è Debes ingresar una contrase√±a');
                return false;
            }

            if (!confirmPassword) {
                alert('‚ö†Ô∏è Debes confirmar la contrase√±a');
                return false;
            }

            if (password !== confirmPassword) {
                alert('‚ö†Ô∏è Las contrase√±as no coinciden');
                return false;
            }

            if (password.length < 4) {
                alert('‚ö†Ô∏è La contrase√±a debe tener al menos 4 caracteres');
                return false;
            }

            try {
                // Guardar contrase√±a
                const authData = JSON.parse(localStorage.getItem(AUTH_KEY) || '{}');
                authData[role] = password;
                localStorage.setItem(AUTH_KEY, JSON.stringify(authData));
                
                console.log('‚úÖ Contrase√±a guardada exitosamente para:', role);
                console.log('üìã Datos actuales:', Object.keys(authData));

                alert(`‚úÖ Contrase√±a para ${role} creada/actualizada exitosamente`);
                
                // Limpiar campos
                document.getElementById('newUserRole').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                showLogin();
                return true;
            } catch (error) {
                console.error('‚ùå Error al guardar contrase√±a:', error);
                alert('‚ùå Error al guardar la contrase√±a. Int√©ntalo de nuevo.');
                return false;
            }
        }

        function login() {
            console.log('üîê Intentando login...');
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value;

            console.log('üìù Datos de login:', { role, password: password ? '***' : 'vac√≠o' });

            if (!role) {
                alert('‚ö†Ô∏è Selecciona un rol');
                return false;
            }

            if (!password) {
                alert('‚ö†Ô∏è Ingresa la contrase√±a');
                return false;
            }

            try {
                const authData = JSON.parse(localStorage.getItem(AUTH_KEY) || '{}');
                console.log('üìã Roles disponibles:', Object.keys(authData));
                
                if (!authData[role]) {
                    alert(`‚ö†Ô∏è No existe contrase√±a para el rol "${role}". Cr√©ala primero.`);
                    showCreatePassword();
                    return false;
                }

                if (authData[role] !== password) {
                    alert('‚ùå Contrase√±a incorrecta');
                    return false;
                }

                // Login exitoso
                console.log('‚úÖ Login exitoso para:', role);
                currentUser = role;
                userRole = role;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('currentUser').textContent = `üë§ ${role.charAt(0).toUpperCase() + role.slice(1)}`;
                
                // Limpiar campos de login
                document.getElementById('userRole').value = '';
                document.getElementById('userPassword').value = '';
                
                initializeSystem();
                return true;
            } catch (error) {
                console.error('‚ùå Error en login:', error);
                alert('‚ùå Error al verificar las credenciales. Int√©ntalo de nuevo.');
                return false;
            }
        }

        function logout() {
            if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
                console.log('üö™ Cerrando sesi√≥n...');
                currentUser = null;
                userRole = null;
                document.getElementById('loginContainer').style.display = 'flex';
                showLogin();
            }
        }

        // Verificar que el usuario est√© autenticado para acciones cr√≠ticas
        function requireAuth(action) {
            if (!currentUser || !userRole) {
                alert('‚ö†Ô∏è Debes iniciar sesi√≥n para realizar esta acci√≥n');
                document.getElementById('loginContainer').style.display = 'flex';
                showLogin();
                return false;
            }
            return true;
        }

        // Auto-guardado cada 30 segundos
        setInterval(saveToStorage, 30000);

        // Cargar datos al iniciar
        function loadFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    inventory = JSON.parse(saved);
                    updateLastSavedTime();
                    return true;
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
            return false;
        }

        // Guardar datos autom√°ticamente
        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(inventory));
                updateLastSavedTime();
                showSaveStatus('üíæ Guardado autom√°tico', 'success');
            } catch (error) {
                console.error('Error guardando datos:', error);
                showSaveStatus('‚ùå Error al guardar', 'error');
            }
        }

        // Actualizar indicador de √∫ltima vez guardado
        function updateLastSavedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('lastSaved').textContent = `- √öltimo guardado: ${timeString}`;
        }

        // Mostrar estado de guardado
        function showSaveStatus(message, type) {
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = message;
            statusEl.className = type === 'success' ? 'auto-save-indicator' : 'offline-indicator';
        }

        // Generar factura con logo
        function generateInvoice() {
            const clientName = document.getElementById('clientName').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const selectedProducts = Array.from(document.getElementById('invoiceProducts').selectedOptions);

            if (!clientName || !invoiceNumber || selectedProducts.length === 0) {
                alert('‚ö†Ô∏è Todos los campos son obligatorios');
                return;
            }

            const printWindow = window.open('', '_blank');
            let total = 0;
            let productRows = '';

            selectedProducts.forEach(option => {
                const productCode = option.value;
                const product = inventory[productCode];
                if (product) {
                    const subtotal = product.salePrice * 1; // Asumimos cantidad 1 por simplicidad
                    total += subtotal;
                    productRows += `
                        <tr>
                            <td>${product.code}</td>
                            <td>${product.description}</td>
                            <td>1</td>
                            <td>$${product.salePrice.toFixed(2)}</td>
                            <td>$${subtotal.toFixed(2)}</td>
