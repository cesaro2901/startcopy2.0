<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StartCopy Inventario</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            padding: 20px;
            color: #ffffff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #2d2d2d;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            overflow: hidden;
            display: none; /* Oculto por defecto hasta el login */
        }

        .header {
            background-color: #1e3a5f;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .portable-badge {
            position: absolute;
            top: 10px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .controls {
            padding: 20px;
            background-color: #3a3a3a;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls input, .controls select, .controls button {
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 14px;
            background-color: #4a4a4a;
            color: white;
        }

        .controls button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .controls button:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60 !important;
        }

        .btn-success:hover {
            background-color: #229954 !important;
        }

        .btn-danger {
            background-color: #e74c3c !important;
        }

        .btn-danger:hover {
            background-color: #c0392b !important;
        }

        .btn-warning {
            background-color: #f39c12 !important;
        }

        .btn-warning:hover {
            background-color: #e67e22 !important;
        }

        .table-container {
            overflow-x: auto;
            background-color: #2a2a2a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th {
            background-color: #1a252f;
            color: #ffffff;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #34495e;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 8px;
            border: 1px solid #444;
            text-align: center;
            background-color: #363636;
            color: #ffffff !important; /* Cambiar a letras blancas */
        }

        .section-header {
            background-color: #4a4a4a;
            color: #ffffff;
            font-weight: bold;
        }

        .inventory-section {
            background-color: #2c5282; /* Azul m√°s oscuro */
            color: #ffffff;
        }

        .sales-section {
            background-color: #742a2a; /* Rojo m√°s oscuro */
            color: #ffffff;
        }

        .entries-section {
            background-color: #2d5016; /* Verde m√°s oscuro */
            color: #ffffff;
        }

        .profit-section {
            background-color: #744210; /* Amarillo/naranja m√°s oscuro */
            color: #ffffff;
        }

        tr:nth-child(even) td {
            background-color: #404040;
        }

        tr:hover td {
            background-color: #4a5568;
        }

        .editable {
            background-color: transparent;
            border: none;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: #ffffff;
        }

        .editable:focus {
            background-color: #555;
            border: 1px solid #3498db;
            outline: none;
        }

        .profit-positive {
            color: #4ade80 !important; /* Verde m√°s brillante */
            font-weight: bold;
        }

        .profit-negative {
            color: #f87171 !important; /* Rojo m√°s brillante */
            font-weight: bold;
        }

        .delete-btn {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .delete-btn:hover {
            background-color: #b91c1c;
        }

        .summary {
            padding: 20px;
            background-color: #3a3a3a;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-card {
            background-color: #4a4a4a;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .summary-card h3 {
            color: #ffffff;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #60a5fa;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #2d2d2d;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            position: relative;
            color: #ffffff;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #ffffff;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ffffff;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #4a4a4a;
            color: #ffffff;
        }

        .form-group input::placeholder {
            color: #aaa;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close:hover {
            color: white;
        }

        .status-bar {
            background-color: #1a252f;
            color: white;
            padding: 10px 20px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .auto-save-indicator {
            color: #4ade80;
            font-weight: bold;
        }

        .file-input {
            display: none;
        }

        .offline-indicator {
            background-color: #dc2626;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .online-indicator {
            background-color: #16a34a;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        /* Estilos para el login */
        #loginContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1a1a1a;
        }

        #loginBox {
            background-color: #2d2d2d;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            text-align: center;
            width: 350px;
        }

        #loginBox h2 {
            margin-bottom: 25px;
            color: #ffffff;
        }

        #loginBox input[type="password"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 16px;
            background-color: #4a4a4a;
            color: #ffffff;
        }

        #loginBox input[type="password"]::placeholder {
            color: #aaa;
        }

        #loginBox button {
            width: 100%;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }

        #loginBox button:hover {
            background-color: #2980b9;
        }

        #loginMessage {
            color: #f87171;
            margin-top: 10px;
            font-weight: bold;
        }

        /* Mejorar contraste en inputs de b√∫squeda */
        #searchInput {
            background-color: #4a4a4a;
            color: #ffffff;
            border: 1px solid #555;
        }

        #searchInput::placeholder {
            color: #aaa;
        }
    </style>
</head>
<body>
    <!-- Contenedor de Login -->
    <div id="loginContainer">
        <div id="loginBox">
            <h2>Acceso al Inventario</h2>
            <input type="password" id="passwordInput" placeholder="Introduce la contrase√±a">
            <button onclick="login()">Entrar</button>
            <p id="loginMessage"></p>
            <button style="margin-top: 15px; background-color: #27ae60;" onclick="openSetPasswordModal()">Establecer Contrase√±a</button>
        </div>
    </div>

    <!-- Contenedor Principal del Inventario (inicialmente oculto) -->
    <div class="container" id="mainInventoryContainer">
        <div class="header">
            <div class="portable-badge">üì± PORTABLE</div>
            <h1>STARTCOPY INVENTARIO</h1>
            <p>Con Auto-Guardado y Respaldo Completo</p>
        </div>

        <div class="controls">
            <button onclick="openModal('product')" class="btn-success">‚ûï Agregar Producto</button>
            <button onclick="openModal('sale')" class="btn-danger">üõí Registrar Venta</button>
            <button onclick="openModal('entry')">üì¶ Registrar Entrada</button>
            <button onclick="openModal('internalUse')" class="btn-danger">‚ûñ Registro de Salida</button> <!-- Nuevo bot√≥n -->
            <button onclick="openModal('invoice')" class="btn-warning">üìÑ Generar Factura</button>
            <button onclick="exportCompleteData()" class="btn-success">üíæ Exportar Datos</button>
            <button onclick="document.getElementById('importFile').click()" class="btn-warning">üì§ Importar Datos</button>
            <button onclick="clearAllData()" class="btn-danger">üóëÔ∏è Limpiar Todo</button>
            <input type="text" id="searchInput" placeholder="üîç Buscar producto..." onkeyup="filterProducts()">
            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(this)">
        </div>

        <div class="table-container">
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th rowspan="2" class="inventory-section">C√ìDIGO<br>PRODUCTO</th>
                        <th rowspan="2" class="inventory-section">DESCRIPCI√ìN</th>
                        <th rowspan="2" class="inventory-section">EXISTENCIAS<br>INICIALES</th>
                        <th rowspan="2" class="inventory-section">ENTRADAS</th>
                        <th rowspan="2" class="inventory-section">SALIDAS<br>VENTA</th> <!-- Cambiado para diferenciar -->
                        <th rowspan="2" class="inventory-section">SALIDAS<br>USO INTERNO</th> <!-- Nueva columna -->
                        <th rowspan="2" class="inventory-section">STOCK<br>ACTUAL</th>
                        <th rowspan="2" class="profit-section">PRECIO<br>BASE ($)</th>
                        <th rowspan="2" class="profit-section">PRECIO<br>VENTA ($)</th>
                        <th rowspan="2" class="profit-section">GANANCIA<br>UNITARIA ($)</th>
                        <th rowspan="2" class="profit-section">GANANCIA<br>TOTAL ($)</th>
                        <th colspan="3" class="sales-section">√öLTIMA VENTA</th>
                        <th colspan="3" class="entries-section">√öLTIMA ENTRADA</th>
                        <th colspan="3" class="sales-section">√öLTIMA SALIDA USO</th> <!-- Nueva columna para √∫ltima salida por uso -->
                        <th rowspan="2" class="inventory-section">ACCIONES</th>
                    </tr>
                    <tr>
                        <th class="sales-section">CANTIDAD</th>
                        <th class="sales-section">FECHA</th>
                        <th class="sales-section">N¬∞ FACTURA</th>
                        <th class="entries-section">CANTIDAD</th>
                        <th class="entries-section">FECHA</th>
                        <th class="entries-section">N¬∞ FACTURA</th>
                        <th class="sales-section">CANTIDAD</th> <!-- Cantidad de √∫ltima salida por uso -->
                        <th class="sales-section">FECHA</th> <!-- Fecha de √∫ltima salida por uso -->
                        <th class="sales-section">MOTIVO</th> <!-- Motivo de √∫ltima salida por uso -->
                    </tr>
                </thead>
                <tbody id="inventoryBody">
                    <!-- Los datos se cargar√°n aqu√≠ din√°micamente -->
                </tbody>
            </table>
        </div>

        <div class="summary">
            <div class="summary-card">
                <h3>Total Productos</h3>
                <div class="value" id="totalProducts">0</div>
            </div>
            <div class="summary-card">
                <h3>Valor Total Inventario</h3>
                <div class="value" id="totalInventoryValue">$0</div>
            </div>
            <div class="summary-card">
                <h3>Ganancia Total</h3>
                <div class="value" id="totalProfit">$0</div>
            </div>
            <div class="summary-card">
                <h3>Productos Bajo Stock</h3>
                <div class="value" id="lowStock">0</div>
            </div>
        </div>

        <div class="status-bar">
            <div>
                <span class="auto-save-indicator" id="saveStatus">üíæ Auto-guardado activo</span>
                <span id="lastSaved"></span>
            </div>
            <div>
                <span id="connectionStatus" class="online-indicator">üåê Sistema Portable</span>
                <span>Versi√≥n: 2.0</span>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('product')">&times;</span>
            <h3>Agregar Producto</h3>
            <form id="productForm">
                <div class="form-group">
                    <label>C√≥digo del Producto:</label>
                    <input type="text" id="productCode" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <input type="text" id="productDescription" required>
                </div>
                <div class="form-group">
                    <label>Stock Inicial:</label>
                    <input type="number" id="initialStock" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Precio Base (Costo):</label>
                    <input type="number" id="basePrice" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Precio de Venta:</label>
                    <input type="number" id="salePrice" step="0.01" min="0" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeModal('product')">Cancelar</button>
                    <button type="submit" class="btn-success">Agregar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="saleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sale')">&times;</span>
            <h3>Registrar Venta</h3>
            <form id="saleForm">
                <div class="form-group">
                    <label>Producto:</label>
                    <select id="saleProduct" required>
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantidad:</label>
                    <input type="number" id="saleQuantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>N√∫mero de Factura:</label>
                    <input type="text" id="saleInvoice">
                </div>
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="saleDate" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeModal('sale')">Cancelar</button>
                    <button type="submit" class="btn-danger">Registrar Venta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="entryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('entry')">&times;</span>
            <h3>Registrar Entrada</h3>
            <form id="entryForm">
                <div class="form-group">
                    <label>Producto:</label>
                    <select id="entryProduct" required>
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantidad:</label>
                    <input type="number" id="entryQuantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>N√∫mero de Factura:</label>
                    <input type="text" id="entryInvoice">
                </div>
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="entryDate" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeModal('entry')">Cancelar</button>
                    <button type="submit" class="btn-success">Registrar Entrada</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Nuevo Modal para Registro de Salida por Uso Interno -->
    <div id="internalUseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('internalUse')">&times;</span>
            <h3>Registro de Salida por Uso Interno</h3>
            <form id="internalUseForm">
                <div class="form-group">
                    <label>Producto:</label>
                    <select id="internalUseProduct" required>
                        <option value="">Seleccionar producto...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantidad:</label>
                    <input type="number" id="internalUseQuantity" min="1" required>
                </div>
                <div class="form-group">
                    <label>Motivo de Salida:</label>
                    <input type="text" id="internalUseReason" placeholder="Ej: Muestra, Consumo interno, Da√±o" required>
                </div>
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="internalUseDate" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeModal('internalUse')">Cancelar</button>
                    <button type="submit" class="btn-danger">Registrar Salida</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Generar Factura -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('invoice')">&times;</span>
            <h3>Generar Factura</h3>
            <form id="invoiceForm">
                <div class="form-group">
                    <label>N√∫mero de Factura:</label>
                    <input type="text" id="invoiceNumber" required>
                </div>
                <div class="form-group">
                    <label>Fecha de Factura:</label>
                    <input type="date" id="invoiceDate" required>
                </div>
                <div class="form-group">
                    <label>Cliente:</label>
                    <input type="text" id="invoiceClient">
                </div>
                <div class="form-group">
                    <label>Detalles de la Factura:</label>
                    <textarea id="invoiceDetails" rows="8" placeholder="Formato sugerido:&#10;Producto 1, 2, 25.00&#10;Producto 2, 1, 15.50&#10;&#10;O descripci√≥n libre de productos y servicios..."></textarea>
                </div>
                <div class="form-group">
                    <label>Productos del Inventario:</label>
                    <select id="invoiceProductSelect" onchange="addProductToInvoice()">
                        <option value="">Seleccionar producto para agregar...</option>
                    </select>
                    <small style="color: #aaa; font-size: 11px;">Selecciona productos de tu inventario para agregarlos autom√°ticamente</small>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeModal('invoice')">Cancelar</button>
                    <button type="submit" class="btn-warning">Crear Factura</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Establecer Contrase√±a -->
    <div id="setPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('setPassword')">&times;</span>
            <h3>Establecer Contrase√±a</h3>
            <form id="setPasswordForm">
                <div class="form-group">
                    <label>Nueva Contrase√±a:</label>
                    <input type="password" id="newPassword" required>
                </div>
                <div class="form-group">
                    <label>Confirmar Contrase√±a:</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" onclick="closeModal('setPassword')">Cancelar</button>
                    <button type="submit" class="btn-success">Guardar Contrase√±a</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cargar jsPDF desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let inventory = {};
        const STORAGE_KEY = 'inventario_portable_v2';
        const PASSWORD_KEY = 'inventario_password'; // Clave para la contrase√±a

        // Auto-guardado cada 30 segundos
        setInterval(saveToStorage, 30000);

        // --- Funciones de Login y Contrase√±a ---
        function openSetPasswordModal() {
            openModal('setPassword');
        }

        document.getElementById('setPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            if (newPass === '') {
                alert('La contrase√±a no puede estar vac√≠a.');
                return;
            }

            if (newPass !== confirmPass) {
                alert('Las contrase√±as no coinciden.');
                return;
            }

            localStorage.setItem(PASSWORD_KEY, newPass);
            alert('Contrase√±a establecida exitosamente.');
            closeModal('setPassword');
        });

        function login() {
            const passwordInput = document.getElementById('passwordInput').value;
            const storedPassword = localStorage.getItem(PASSWORD_KEY);
            const loginMessage = document.getElementById('loginMessage');

            if (!storedPassword) {
                loginMessage.textContent = 'Por favor, establece una contrase√±a primero.';
                return;
            }

            if (passwordInput === storedPassword) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainInventoryContainer').style.display = 'block';
                initializeSystem(); // Inicializar el sistema despu√©s del login
            } else {
                loginMessage.textContent = 'Contrase√±a incorrecta.';
            }
        }

        // --- Funciones de Inventario (existentes y modificadas) ---

        // Cargar datos al iniciar
        function loadFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const loadedInventory = JSON.parse(saved);
                    // Asegurarse de que los productos antiguos tengan la propiedad internalUses
                    for (const code in loadedInventory) {
                        if (!loadedInventory[code].internalUses) {
                            loadedInventory[code].internalUses = 0;
                        }
                        if (!loadedInventory[code].lastInternalUse) {
                            loadedInventory[code].lastInternalUse = { quantity: 0, date: '', reason: '' };
                        }
                    }
                    inventory = loadedInventory;
                    updateLastSavedTime();
                    return true;
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
            return false;
        }

        // Guardar datos autom√°ticamente
        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(inventory));
                updateLastSavedTime();
                showSaveStatus('üíæ Guardado autom√°tico', 'success');
            } catch (error) {
                console.error('Error guardando datos:', error);
                showSaveStatus('‚ùå Error al guardar', 'error');
            }
        }

        // Actualizar indicador de √∫ltima vez guardado
        function updateLastSavedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('lastSaved').textContent = `- √öltimo guardado: ${timeString}`;
        }

        // Mostrar estado de guardado
        function showSaveStatus(message, type) {
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = message;
            statusEl.className = type === 'success' ? 'auto-save-indicator' : 'offline-indicator';
        }

        // Exportar datos completos
        function exportCompleteData() {
            const exportData = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                inventory: inventory,
                summary: calculateSummary()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventario_completo_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSaveStatus('üì§ Datos exportados', 'success');
        }

        // Importar datos
        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Verificar si es un archivo v√°lido
                    if (data.inventory) {
                        inventory = data.inventory;
                    } else {
                        // Formato antiguo
                        inventory = data;
                    }
                    // Asegurarse de que los productos importados tengan la propiedad internalUses
                    for (const code in inventory) {
                        if (!inventory[code].internalUses) {
                            inventory[code].internalUses = 0;
                        }
                        if (!inventory[code].lastInternalUse) {
                            inventory[code].lastInternalUse = { quantity: 0, date: '', reason: '' };
                        }
                    }

                    saveToStorage();
                    updateTable();
                    updateSummary();
                    updateProductSelectors();
                    
                    alert('‚úÖ Datos importados exitosamente');
                    showSaveStatus('üì• Datos importados', 'success');
                } catch (error) {
                    alert('‚ùå Error al importar datos. Verifica que el archivo sea v√°lido.');
                    console.error('Error:', error);
                }
            };
            reader.readAsText(file);
            
            // Limpiar input
            input.value = '';
        }

        // Limpiar todos los datos
        function clearAllData() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar TODOS los datos?\n\nEsta acci√≥n no se puede deshacer.')) {
                if (confirm('üîí Confirmaci√≥n final: Se perder√°n todos los productos y movimientos.')) {
                    inventory = {};
                    localStorage.removeItem(STORAGE_KEY);
                    updateTable();
                    updateSummary();
                    updateProductSelectors();
                    showSaveStatus('üóëÔ∏è Datos eliminados', 'error');
                    alert('‚úÖ Todos los datos han sido eliminados.');
                }
            }
        }

        // Calcular resumen
        function calculateSummary() {
            const totalProducts = Object.keys(inventory).length;
            let totalInventoryValue = 0;
            let totalProfit = 0;
            let lowStock = 0;

            Object.values(inventory).forEach(product => {
                // Stock actual ahora considera ventas y uso interno
                const currentStock = product.initialStock + product.entries - product.sales - (product.internalUses || 0);
                totalInventoryValue += currentStock * product.basePrice;
                totalProfit += (product.salePrice - product.basePrice) * product.sales; // Ganancia solo por ventas
                if (currentStock <= 5) lowStock++;
            });

            return { totalProducts, totalInventoryValue, totalProfit, lowStock };
        }

        // Inicializar sistema
        function initializeSystem() {
            // Cargar datos guardados
            if (!loadFromStorage()) {
                // Si no hay datos guardados, usar datos de ejemplo
                const sampleData = {
                    'AN001': {
                        code: 'AN001',
                        description: 'Anillo Oro plata',
                        initialStock: 10,
                        entries: 5,
                        sales: 3,
                        internalUses: 1, // A√±adido para el ejemplo
                        basePrice: 25.00,
                        salePrice: 45.00,
                        lastSale: { quantity: 1, date: '2024-01-15', invoice: 'F001' },
                        lastEntry: { quantity: 5, date: '2024-01-10', invoice: 'C001' },
                        lastInternalUse: { quantity: 1, date: '2024-01-20', reason: 'Muestra' } // A√±adido para el ejemplo
                    }
                };
                inventory = sampleData;
                saveToStorage();
            }

            updateTable();
            updateSummary();
            updateProductSelectors();
            
            // Establecer fecha actual por defecto
            document.getElementById('saleDate').valueAsDate = new Date();
            document.getElementById('entryDate').valueAsDate = new Date();
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('internalUseDate').valueAsDate = new Date(); // Fecha para uso interno

            showSaveStatus('‚úÖ Sistema iniciado', 'success');
        }

        function updateTable() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';

            Object.values(inventory).forEach(product => {
                // Stock actual ahora considera ventas y uso interno
                const currentStock = product.initialStock + product.entries - product.sales - (product.internalUses || 0);
                const unitProfit = product.salePrice - product.basePrice;
                const totalProfit = unitProfit * product.sales; // Ganancia solo por ventas
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${product.code}</td>
                    <td>${product.description}</td>
                    <td>${product.initialStock}</td>
                    <td>${product.entries}</td>
                    <td>${product.sales}</td>
                    <td>${product.internalUses || 0}</td> <!-- Mostrar salidas por uso interno -->
                    <td style="font-weight: bold; ${currentStock <= 5 ? 'color: #f87171 !important;' : ''}">${currentStock}</td>
                    <td>${product.basePrice.toFixed(2)}</td>
                    <td>${product.salePrice.toFixed(2)}</td>
                    <td class="${unitProfit >= 0 ? 'profit-positive' : 'profit-negative'}">${unitProfit.toFixed(2)}</td>
                    <td class="${totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}">${totalProfit.toFixed(2)}</td>
                    <td>${product.lastSale.quantity || '-'}</td>
                    <td>${product.lastSale.date || '-'}</td>
                    <td>${product.lastSale.invoice || '-'}</td>
                    <td>${product.lastEntry.quantity || '-'}</td>
                    <td>${product.lastEntry.date || '-'}</td>
                    <td>${product.lastEntry.invoice || '-'}</td>
                    <td>${product.lastInternalUse.quantity || '-'}</td> <!-- √öltima salida por uso -->
                    <td>${product.lastInternalUse.date || '-'}</td> <!-- Fecha de √∫ltima salida por uso -->
                    <td>${product.lastInternalUse.reason || '-'}</td> <!-- Motivo de √∫ltima salida por uso -->
                    <td><button class="delete-btn" onclick="deleteProduct('${product.code}')">Eliminar</button></td>
                `;
            });
        }

        function updateSummary() {
            const summary = calculateSummary();
            document.getElementById('totalProducts').textContent = summary.totalProducts;
            document.getElementById('totalInventoryValue').textContent = `${summary.totalInventoryValue.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `${summary.totalProfit.toFixed(2)}`;
            document.getElementById('lowStock').textContent = summary.lowStock;
        }

        function updateProductSelectors() {
            const saleSelect = document.getElementById('saleProduct');
            const entrySelect = document.getElementById('entryProduct');
            const internalUseSelect = document.getElementById('internalUseProduct'); // Nuevo selector
            const invoiceSelect = document.getElementById('invoiceProductSelect'); // Para facturas
            
            saleSelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            entrySelect.innerHTML = '<option value="">Seleccionar producto...</option>';
            internalUseSelect.innerHTML = '<option value="">Seleccionar producto...</option>'; // Limpiar y rellenar
            invoiceSelect.innerHTML = '<option value="">Seleccionar producto para agregar...</option>';

            Object.values(inventory).forEach(product => {
                const option = `<option value="${product.code}">${product.code} - ${product.description}</option>`;
                saleSelect.innerHTML += option;
                entrySelect.innerHTML += option;
                internalUseSelect.innerHTML += option;
                invoiceSelect.innerHTML += option;
            });
        }

        // Funci√≥n para agregar producto a la factura
        function addProductToInvoice() {
            const selectElement = document.getElementById('invoiceProductSelect');
            const productCode = selectElement.value;
            const detailsTextarea = document.getElementById('invoiceDetails');
            
            if (!productCode) return;
            
            const product = inventory[productCode];
            if (!product) return;
            
            // Formato: Descripci√≥n, Cantidad, Precio
            const productLine = `${product.description}, 1, ${product.salePrice.toFixed(2)}`;
            
            // Agregar al textarea
            if (detailsTextarea.value) {
                detailsTextarea.value += '\n' + productLine;
            } else {
                detailsTextarea.value = productLine;
            }
            
            // Resetear selector
            selectElement.value = '';
        }

        function openModal(type) {
            document.getElementById(type + 'Modal').style.display = 'flex'; // Usar flex para centrar
        }

        function closeModal(type) {
            document.getElementById(type + 'Modal').style.display = 'none';
            // Resetear el formulario si existe
            const form = document.getElementById(type + 'Form');
            if (form) {
                form.reset();
            }
        }

        // Event Listeners
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = document.getElementById('productCode').value;
            const description = document.getElementById('productDescription').value;
            const initialStock = parseInt(document.getElementById('initialStock').value);
            const basePrice = parseFloat(document.getElementById('basePrice').value);
            const salePrice = parseFloat(document.getElementById('salePrice').value);

            if (inventory[code]) {
                alert('El c√≥digo de producto ya existe');
                return;
            }

            inventory[code] = {
                code: code,
                description: description,
                initialStock: initialStock,
                entries: 0,
                sales: 0,
                internalUses: 0, // Inicializar nueva propiedad
                basePrice: basePrice,
                salePrice: salePrice,
                lastSale: { quantity: 0, date: '', invoice: '' },
                lastEntry: { quantity: 0, date: '', invoice: '' },
                lastInternalUse: { quantity: 0, date: '', reason: '' } // Inicializar nueva propiedad
            };

            saveToStorage();
            updateTable();
            updateSummary();
            updateProductSelectors();
            closeModal('product');
            alert('Producto agregado exitosamente');
            showSaveStatus('‚ûï Producto agregado', 'success');
        });

        document.getElementById('saleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productCode = document.getElementById('saleProduct').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const invoice = document.getElementById('saleInvoice').value;
            const date = document.getElementById('saleDate').value;

            if (!inventory[productCode]) {
                alert('Producto no encontrado');
                return;
            }

            // Stock actual ahora considera ventas y uso interno
            const currentStock = inventory[productCode].initialStock + inventory[productCode].entries - inventory[productCode].sales - (inventory[productCode].internalUses || 0);
            if (quantity > currentStock) {
                alert('No hay suficiente stock disponible');
                return;
            }

            inventory[productCode].sales += quantity;
            inventory[productCode].lastSale = { quantity: quantity, date: date, invoice: invoice };

            saveToStorage();
            updateTable();
            updateSummary();
            closeModal('sale');
            alert('Venta registrada exitosamente');
            showSaveStatus('üõí Venta registrada', 'success');
        });

        document.getElementById('entryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productCode = document.getElementById('entryProduct').value;
            const quantity = parseInt(document.getElementById('entryQuantity').value);
            const invoice = document.getElementById('entryInvoice').value;
            const date = document.getElementById('entryDate').value;

            if (!inventory[productCode]) {
                alert('Producto no encontrado');
                return;
            }

            inventory[productCode].entries += quantity;
            inventory[productCode].lastEntry = { quantity: quantity, date: date, invoice: invoice };

            saveToStorage();
            updateTable();
            updateSummary();
            closeModal('entry');
            alert('Entrada registrada exitosamente');
            showSaveStatus('üì¶ Entrada registrada', 'success');
        });

        // Event Listener para el formulario de Salida por Uso Interno
        document.getElementById('internalUseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productCode = document.getElementById('internalUseProduct').value;
            const quantity = parseInt(document.getElementById('internalUseQuantity').value);
            const reason = document.getElementById('internalUseReason').value;
            const date = document.getElementById('internalUseDate').value;

            if (!inventory[productCode]) {
                alert('Producto no encontrado');
                return;
            }

            // Stock actual ahora considera ventas y uso interno
            const currentStock = inventory[productCode].initialStock + inventory[productCode].entries - inventory[productCode].sales - (inventory[productCode].internalUses || 0);
            if (quantity > currentStock) {
                alert('No hay suficiente stock disponible para uso interno.');
                return;
            }

            // Asegurarse de que la propiedad exista antes de sumar
            if (!inventory[productCode].internalUses) {
                inventory[productCode].internalUses = 0;
            }
            inventory[productCode].internalUses += quantity;
            inventory[productCode].lastInternalUse = { quantity: quantity, date: date, reason: reason };

            saveToStorage();
            updateTable();
            updateSummary();
            closeModal('internalUse');
            alert('Salida por uso interno registrada exitosamente.');
            showSaveStatus('‚ûñ Salida por uso registrada', 'success');
        });

        // Event Listener para el formulario de Factura
        document.getElementById('invoiceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceClient = document.getElementById('invoiceClient').value;
            const invoiceDetails = document.getElementById('invoiceDetails').value;

            generateInvoicePDF(invoiceNumber, invoiceDate, invoiceClient, invoiceDetails);
            
            closeModal('invoice');
            showSaveStatus('üìÑ Factura PDF generada', 'success');
        });

        // Funci√≥n para generar PDF de factura
        function generateInvoicePDF(invoiceNumber, invoiceDate, client, details) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configurar fuente
            doc.setFont('helvetica');
            
            // Header de la empresa
            doc.setFontSize(20);
            doc.setTextColor(44, 62, 80);
            doc.text('STARTCOPY', 20, 25);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('Sistema de Inventario', 20, 32);
            doc.text('Tel: (XXX) XXX-XXXX', 20, 39);
            doc.text('Email: info@startcopy.com', 20, 46);
            
            // L√≠nea separadora
            doc.setLineWidth(0.5);
            doc.line(20, 55, 190, 55);
            
            // T√≠tulo de factura
            doc.setFontSize(18);
            doc.setTextColor(231, 76, 60);
            doc.text('FACTURA', 150, 25);
            
            // Informaci√≥n de la factura
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`N¬∞ Factura: ${invoiceNumber}`, 150, 32);
            doc.text(`Fecha: ${invoiceDate}`, 150, 39);
            
            // Informaci√≥n del cliente
            doc.setFontSize(14);
            doc.setTextColor(44, 62, 80);
            doc.text('FACTURAR A:', 20, 70);
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            if (client) {
                doc.text(client, 20, 80);
            } else {
                doc.text('Cliente General', 20, 80);
            }
            
            // Tabla de productos/servicios
            let yPosition = 100;
            
            // Headers de tabla
            doc.setFillColor(52, 73, 94);
            doc.rect(20, yPosition, 170, 10, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('DESCRIPCI√ìN', 25, yPosition + 7);
            doc.text('CANT.', 120, yPosition + 7);
            doc.text('PRECIO', 140, yPosition + 7);
            doc.text('TOTAL', 170, yPosition + 7);
            
            yPosition += 15;
            
            // Procesar detalles de la factura
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(8);
            
            let totalAmount = 0;
            
            if (details) {
                const lines = details.split('\n');
                lines.forEach((line, index) => {
                    if (line.trim() && yPosition < 250) {
                        // Intentar extraer informaci√≥n estructurada
                        const parts = line.split(',').map(part => part.trim());
                        
                        if (parts.length >= 3) {
                            // Formato: Producto, Cantidad, Precio
                            const [product, quantity, price] = parts;
                            const qty = parseFloat(quantity) || 1;
                            const unitPrice = parseFloat(price.replace(/[^\d.-]/g, '')) || 0;
                            const lineTotal = qty * unitPrice;
                            
                            doc.text(product.substring(0, 40), 25, yPosition);
                            doc.text(qty.toString(), 125, yPosition);
                            doc.text(`${unitPrice.toFixed(2)}`, 142, yPosition);
                            doc.text(`${lineTotal.toFixed(2)}`, 172, yPosition);
                            
                            totalAmount += lineTotal;
                        } else {
                            // Formato libre
                            doc.text(line.substring(0, 80), 25, yPosition);
                        }
                        
                        yPosition += 8;
                    }
                });
            } else {
                doc.text('Sin detalles especificados', 25, yPosition);
                yPosition += 8;
            }
            
            // L√≠nea de separaci√≥n antes del total
            yPosition += 10;
            doc.setLineWidth(0.3);
            doc.line(120, yPosition, 190, yPosition);
            
            // Total
            yPosition += 10;
            doc.setFontSize(12);
            doc.setTextColor(44, 62, 80);
            if (totalAmount > 0) {
                doc.text(`TOTAL: ${totalAmount.toFixed(2)}`, 150, yPosition);
            } else {
                doc.text('TOTAL: A convenir', 150, yPosition);
            }
            
            // Informaci√≥n adicional
            yPosition += 25;
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Gracias por su preferencia', 20, yPosition);
            doc.text('Esta factura fue generada autom√°ticamente por el Sistema de Inventario StartCopy', 20, yPosition + 10);
            
            // Generar y descargar el PDF
            const fileName = `Factura_${invoiceNumber}_${invoiceDate}.pdf`;
            doc.save(fileName);
            
            alert(`‚úÖ Factura PDF generada exitosamente: ${fileName}`);
        }


        function deleteProduct(code) {
            if (confirm(`¬øEst√° seguro de eliminar el producto ${code}?`)) {
                delete inventory[code];
                saveToStorage();
                updateTable();
                updateSummary();
                updateProductSelectors();
                showSaveStatus('üóëÔ∏è Producto eliminado', 'success');
            }
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tbody = document.getElementById('inventoryBody');
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                const code = row.cells[0].textContent.toLowerCase();
                const description = row.cells[1].textContent.toLowerCase();
                
                if (code.includes(searchTerm) || description.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        // Cerrar modales al hacer clic fuera de ellos
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // Detectar cambios de visibilidad para auto-guardar
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveToStorage();
            }
        });

        // Guardar antes de cerrar la p√°gina
        window.addEventListener('beforeunload', function() {
            saveToStorage();
        });

        // No llamar initializeSystem() aqu√≠, se llamar√° despu√©s del login exitoso
        // initializeSystem(); 
    </script>
</body>
</html>